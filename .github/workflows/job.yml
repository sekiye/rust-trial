name: Job

on:
  workflow_dispatch: {}
  schedule:
    # Runs at 03:00 UTC everyday
    - cron: '0 3 * * *'

jobs:
  test:
    name: Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - uses: Swatinem/rust-cache@v2
      - uses: actions-rs/cargo@v1
        env:
          DEVELOPER_KEY0: ${{ secrets.DEVELOPER_KEY0 }}
          DEVELOPER_KEY1: ${{ secrets.DEVELOPER_KEY1 }}
          DEVELOPER_KEY2: ${{ secrets.DEVELOPER_KEY2 }}
          DEVELOPER_KEY3: ${{ secrets.DEVELOPER_KEY3 }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          QUERY_URL_BASE: ${{ secrets.QUERY_URL_BASE }}
          LOCATION_URL_BASE: ${{ secrets.LOCATION_URL_BASE }}
          LIVE_URL_BASE: ${{ secrets.LIVE_URL_BASE }}
          INFO_URL_BASE: ${{ secrets.INFO_URL_BASE }}
          DATA_URL: ${{ secrets.DATA_URL }}
          QUERIES_URL: ${{ secrets.QUERIES_URL }}
          BLACKLIST_URL: ${{ secrets.BLACKLIST_URL }}
          WATCH_URL: ${{ secrets.WATCH_URL }}
        with:
          command: run
          args: --bin=rust-trial --package=rust-trial --manifest-path=Cargo.toml --message-format=json remove_only
      - id: "auth"
        uses: "google-github-actions/auth@v1"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"
      - name: "Upload geo"
        run: "gcloud storage cp geo.csv.gz gs://livecameramap-54d8d.appspot.com"
      - uses: montudor/action-zip@v1
        with:
          args: zip -qq -e --password="${{ secrets.ZIP_PASSWORD }}" geo.csv.gz.zip geo.csv.gz
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: ./geo.csv.gz.zip